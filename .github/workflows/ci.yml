name: Continuous Integration

on:
  workflow_call:
    inputs:
      main_ontology: { required: true, type: string }
      shapes_glob:   { required: false, type: string, default: "shapes/**/*.ttl" }
      data_glob:     { required: false, type: string, default: "data/**/*.ttl" }
      reasoner:      { required: false, type: string, default: "elk" }
    secrets:
      GH_TOKEN:      { required: false }

permissions:
  contents: write

concurrency:
  group: ci-qa-${{ github.ref }}
  cancel-in-progress: false

jobs:

  qa:
    runs-on: ubuntu-latest
    outputs:
      reasoned_path: reports/reasoned.owl
    steps:
      - name: Checkout calling repo
        uses: actions/checkout@v4
        with:
          path: calling-repo
          token: ${{ secrets.GH_TOKEN || secrets.GITHUB_TOKEN }}
          fetch-depth: 0

      # Java for ROBOT
      - uses: actions/setup-java@v4
        with: { distribution: temurin, java-version: '17' }

      # Python for pySHACL
      - uses: actions/setup-python@v5
        with: { python-version: '3.11' }
      - run: pip install pyshacl==0.25.0 rdflib==7.0.0

      # Install ROBOT
      - name: Install ROBOT
        run: |
          curl -sL -o robot.jar https://github.com/ontodev/robot/releases/download/v1.9.7/robot.jar

      - name: OWL Profile Validation
        continue-on-error: true
        run: |
          mkdir -p calling-repo/reports
          
          # Initialize the profiles report
          cat > calling-repo/reports/profiles.md <<EOF
          # OWL Profile Validation Report
          
          **Ontology**: ${{ inputs.main_ontology }}
          **Date**: $(date -u +"%Y-%m-%d %H:%M:%S UTC")
          
          ---
          
          EOF
          
          # Validate against OWL2 DL profile
          echo "## OWL2 DL Profile" >> calling-repo/reports/profiles.md
          echo "" >> calling-repo/reports/profiles.md
          if java -jar robot.jar validate-profile --profile DL \
            --input "calling-repo/${{ inputs.main_ontology }}" \
            --output calling-repo/reports/profile-dl-validation.txt 2>&1; then
            echo "✅ **Status**: PASSED" >> calling-repo/reports/profiles.md
            echo "" >> calling-repo/reports/profiles.md
            if [ -f calling-repo/reports/profile-dl-validation.txt ]; then
              echo '```' >> calling-repo/reports/profiles.md
              cat calling-repo/reports/profile-dl-validation.txt >> calling-repo/reports/profiles.md
              echo '```' >> calling-repo/reports/profiles.md
            fi
          else
            echo "⚠️ **Status**: VIOLATIONS DETECTED" >> calling-repo/reports/profiles.md
            echo "" >> calling-repo/reports/profiles.md
            if [ -f calling-repo/reports/profile-dl-validation.txt ]; then
              echo '```' >> calling-repo/reports/profiles.md
              cat calling-repo/reports/profile-dl-validation.txt >> calling-repo/reports/profiles.md
              echo '```' >> calling-repo/reports/profiles.md
            fi
          fi
          echo "" >> calling-repo/reports/profiles.md
          
          # Validate against OWL2 RL profile
          echo "## OWL2 RL Profile" >> calling-repo/reports/profiles.md
          echo "" >> calling-repo/reports/profiles.md
          if java -jar robot.jar validate-profile --profile RL \
            --input "calling-repo/${{ inputs.main_ontology }}" \
            --output calling-repo/reports/profile-rl-validation.txt 2>&1; then
            echo "✅ **Status**: PASSED" >> calling-repo/reports/profiles.md
            echo "" >> calling-repo/reports/profiles.md
            if [ -f calling-repo/reports/profile-rl-validation.txt ]; then
              echo '```' >> calling-repo/reports/profiles.md
              cat calling-repo/reports/profile-rl-validation.txt >> calling-repo/reports/profiles.md
              echo '```' >> calling-repo/reports/profiles.md
            fi
          else
            echo "⚠️ **Status**: VIOLATIONS DETECTED" >> calling-repo/reports/profiles.md
            echo "" >> calling-repo/reports/profiles.md
            if [ -f calling-repo/reports/profile-rl-validation.txt ]; then
              echo '```' >> calling-repo/reports/profiles.md
              cat calling-repo/reports/profile-rl-validation.txt >> calling-repo/reports/profiles.md
              echo '```' >> calling-repo/reports/profiles.md
            fi
          fi
          
          # Clean up temporary validation files
          rm -f calling-repo/reports/profile-dl-validation.txt calling-repo/reports/profile-rl-validation.txt
          
          echo "Profile validation completed - see reports/profiles.md for details"

      - name: Reasoning & consistency
        run: |
          mkdir -p calling-repo/reports
          java -jar robot.jar reason \
            --input "calling-repo/${{ inputs.main_ontology }}" \
            --reasoner "${{ inputs.reasoner }}" \
            --equivalent-classes-allowed all \
            --exclude-tautologies structural \
            --output calling-repo/reports/reasoned.owl
          echo "Reasoning OK" > calling-repo/reports/reasoning.txt

      - name: Structural report
        run: |
          java -jar robot.jar report --input "calling-repo/${{ inputs.main_ontology }}" --output calling-repo/reports/robot-report.tsv --fail-on NONE

      - name: SHACL validation (A-Box)
        if: inputs.shapes_glob != ''
        run: |
          python - <<'PY'
          import glob, subprocess, sys
          shapes = glob.glob("${{ inputs.shapes_glob }}", recursive=True)
          data   = glob.glob("${{ inputs.data_glob }}",   recursive=True)
          failed = 0
          for s in shapes or []:
            cmd = ["pyshacl","-s",s]
            if data:
              for d in data:
                rc = subprocess.call(cmd+["-d", d, "-o", "turtle", "-r", "both"])
                failed |= (rc != 0)
            else:
              rc = subprocess.call(cmd+["-d","${{ inputs.main_ontology }}","-o","turtle","-r","both"])
              failed |= (rc != 0)
          sys.exit(failed)
          PY

      - name: Commit QA reports to repository
        run: |
          cd calling-repo
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          
          # Show what reports were generated
          echo "Generated reports:"
          ls -la reports/ || echo "No reports directory found"
          
          git add reports/
          
          if ! git diff --cached --quiet; then
            echo "Committing reports..."
            git commit -m "Update QA reports [$(date -u +"%Y-%m-%d %H:%M:%S UTC")]"
            echo "Pushing reports to repository..."
            git push
          else
            echo "No changes to commit"
          fi

      - name: Upload QA artifacts
        uses: actions/upload-artifact@v4
        with:
          name: qa-reports
          path: calling-repo/reports
